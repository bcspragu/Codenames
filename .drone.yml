pipeline:
  backend:
    group: build
    image: golang:1.11
    commands:
      - export GO111MODULE=on
      - export GOPROXY=https://athens.bsprague.com
      - CGO_ENABLED=0 GOOS=linux go build -ldflags '-extldflags "-static" -s -w' -o cmd/codenames-server/server github.com/bcspragu/Codenames/cmd/codenames-server
      - go test ./...
  frontend:
    group: build
    image: docker.bsprague.com/node
    commands:
      - cd web/frontend
      - yarn
      - yarn build
    volumes:
      - /tmp/nodecache:/drone/src/github.com/bcspragu/Codenames/web/frontend/node_modules
  docker:
    image: plugins/docker
    repo: docker.bsprague.com/codenames
    registry: docker.bsprague.com
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
    dockerfile: cmd/codenames-server/Dockerfile
    context: cmd/codenames-server/
  scp:
    group: deploy
    image: appleboy/drone-scp
    host: prod.bsprague.com
    username:
      from_secret: ssh_username
    key:
      from_secret: ssh_key
    target: /var/www/codenames.ai
    source: web/frontend/dist/*
    rm: true
    strip_components: 3
  ssh:
    group: deploy
    image: appleboy/drone-ssh
    host: prod.bsprague.com
    username:
      from_secret: ssh_username
    key:
      from_secret: ssh_key
    script:
      - sudo systemctl restart codenames.service

branches: master
